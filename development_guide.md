# 狗叫声验证系统开发指南

## 项目概述

本项目是一个狗叫声验证系统，能够识别和验证音频中是否包含特定狗的叫声。系统包含以下几个主要模块：

1. 预筛选器（Prefilter）- 对输入音频进行初步筛选，检测高能量事件
2. 狗叫声裁剪器（SED Cropper）- 使用声音事件检测模型精确裁剪狗叫声片段
3. 模板管理器（Template Manager）- 管理和保存狗的特征模板
4. 验证器（Verifier）- 验证音频片段是否匹配特定狗的叫声模板

## 模块开发与测试指南

### 1. 预筛选器（Prefilter）模块

#### 功能说明
该模块用于对输入音频进行初步筛选，检测可能包含狗叫声的高能量片段。

#### 核心方法
- `detect_events(audio, hop_length=160)` - 检测音频中的高能量事件

#### 开发要点
- 能量阈值参数可调，以适应不同环境下的音频
- 最小持续时间设置，过滤掉过短的事件
- 返回格式为[(start, end), ...]的片段位置列表

#### 单元测试建议
1. 测试纯静音音频，应返回空列表
2. 测试包含明显声音的音频，验证检测准确性
3. 测试不同hop_length参数的影响
4. 测试边界情况，如音频长度小于最小检测窗口

### 2. 狗叫声裁剪器（SED Cropper）模块

#### 功能说明
使用声音事件检测模型对预筛选出的音频片段进行精确裁剪，提取真正的狗叫声片段。

#### 核心方法
- `crop_barks(audio_segment)` - 输入音频片段，输出精确的狗叫声列表

#### 开发要点
- 滑动窗口处理音频片段
- 使用MFCC特征提取
- TensorFlow模型推理
- 后处理合并连续高概率窗口

#### 单元测试建议
1. 测试空音频输入，应返回空列表
2. 测试包含狗叫声的音频片段，验证裁剪准确性
3. 测试模型推理结果处理逻辑
4. 测试滑动窗口生成逻辑
5. 测试后处理合并逻辑

### 3. 模板管理器（Template Manager）模块

#### 功能说明
管理狗叫声模板，包括注册新狗、保存和加载模板。

#### 核心方法
- `register_dog(dog_id, audio_files)` - 注册新狗及其叫声模板
- `save_templates(path)` - 保存所有模板到文件
- `load_templates(path)` - 从文件加载模板

#### 开发要点
- 使用logmel特征提取
- TensorFlow模型生成嵌入向量
- 模板向量归一化处理
- 多个音频文件生成平均模板

#### 单元测试建议
1. 测试狗注册功能，验证模板生成
2. 测试模板保存和加载功能
3. 测试多个音频文件生成平均模板的准确性
4. 测试嵌入向量归一化处理
5. 测试无效音频文件处理

### 4. 验证器（Verifier）模块

#### 功能说明
验证输入的狗叫声片段是否匹配特定狗的模板。

#### 核心方法
- `verify(bark_audio, target_dog_id=None)` - 验证音频片段是否匹配目标狗

#### 开发要点
- 特征提取和嵌入向量生成
- 余弦相似度计算
- 支持指定狗验证和最相似狗查找

#### 单元测试建议
1. 测试与已知狗叫声的匹配准确性
2. 测试与未知狗叫声的不匹配情况
3. 测试相似狗叫声的区分能力
4. 测试阈值参数对结果的影响
5. 测试未注册狗的处理

## 集成测试流程

### 阶段一：模块独立测试
1. 分别对每个模块进行功能测试
2. 确保各模块的输入输出符合预期
3. 验证边界条件和异常处理

### 阶段二：模块间接口测试
1. 测试Prefilter到Cropper的数据传递
2. 测试Cropper到Verifier的数据传递
3. 验证TemplateManager与其他模块的交互

### 阶段三：完整流程测试
1. 运行demo.py，验证整个流程
2. 使用多种测试音频验证系统准确性
3. 性能测试，确保处理速度满足要求

## 注意事项

1. 所有音频处理统一使用16kHz采样率
2. 特征提取函数需要保持一致性
3. TensorFlow模型加载和推理需要正确处理
4. 向量归一化处理要保持一致
5. 异常情况处理（如文件不存在、模型加载失败等）